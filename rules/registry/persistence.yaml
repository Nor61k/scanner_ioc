# Правила для обнаружения механизмов персистентности

rules:
  # Модификация загрузчика
  bootloader_modification:
    paths:
      - "HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\BootExecute"
      - "HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\SetupExecute"
    indicators:
      - ".*\\.exe"
      - ".*\\.dll"
      - ".*\\.sys"
      
  # Модификация AppInit_DLLs
  appinit_dlls:
    paths:
      - "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_DLLs"
      - "HKLM\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_DLLs"
    indicators:
      - ".*\\.dll"
      
  # Модификация Winlogon
  winlogon_modification:
    paths:
      - "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon"
    indicators:
      - "Shell=.*"
      - "Userinit=.*"
      - "System=.*"
      
  # COM объекты автозапуска
  com_autorun:
    paths:
      - "HKLM\\SOFTWARE\\Classes\\CLSID\\{.*}\\InprocServer32"
      - "HKCU\\SOFTWARE\\Classes\\CLSID\\{.*}\\InprocServer32"
    indicators:
      - ".*\\Windows\\Temp\\.*\\.dll"
      - ".*\\AppData\\Local\\Temp\\.*\\.dll"
      - ".*\\Users\\Public\\.*\\.dll"
      
  # Модификация Image File Execution Options
  ifeo_modification:
    paths:
      - "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options"
    indicators:
      - "Debugger=.*"
      
  # Модификация Explorer Extensions
  explorer_extensions:
    paths:
      - "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Browser Helper Objects"
      - "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellIconOverlayIdentifiers"
      - "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellExecuteHooks"
    indicators:
      - ".*\\Windows\\Temp\\.*\\.dll"
      - ".*\\AppData\\Local\\Temp\\.*\\.dll"
      - ".*\\Users\\Public\\.*\\.dll"
      
  # Модификация WMI
  wmi_persistence:
    paths:
      - "HKLM\\SOFTWARE\\Microsoft\\Wbem\\CIMOM"
      - "HKLM\\SOFTWARE\\Microsoft\\Wbem\\ESS"
    indicators:
      - ".*\\.mof"
      - ".*\\.vbs"
      - ".*\\.js"
      
  # Модификация SilentProcessExit
  silent_process_exit:
    paths:
      - "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit"
    indicators:
      - "MonitorProcess=.*"
      
  # Модификация Office Add-ins
  office_addins:
    paths:
      - "HKCU\\SOFTWARE\\Microsoft\\Office\\.*\\Word\\Addins"
      - "HKCU\\SOFTWARE\\Microsoft\\Office\\.*\\Excel\\Addins"
      - "HKCU\\SOFTWARE\\Microsoft\\Office\\.*\\PowerPoint\\Addins"
      - "HKCU\\SOFTWARE\\Microsoft\\Office\\.*\\Outlook\\Addins"
    indicators:
      - ".*\\Windows\\Temp\\.*"
      - ".*\\AppData\\Local\\Temp\\.*"
      - ".*\\Users\\Public\\.*"

  persistence_mechanisms:
    description: "Механизмы персистентности"
    paths:
      - "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon"
      - "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows"
      - "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders"
      - "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\User Shell Folders"
    indicators:
      - "Userinit=.*,.*"  # Множественные записи
      - "Shell=.*,.*"     # Множественные записи
      - "load=.*"         # Подозрительные DLL
      - "AppInit_DLLs=.*" # Инжекция DLL
    severity: high
    tags:
      - persistence
      - configuration 