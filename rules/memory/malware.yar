import "math"

/*
    Правила YARA для обнаружения вредоносной активности в памяти процессов
*/

rule generic_shellcode {
    meta:
        description = "Обнаружение шелл-кода в памяти"
        author = "RuScan"
        severity = "high"
        
    strings:
        $push_regs = { 55 8B EC 83 C4 }  // push ebp, mov ebp, esp, add esp
        $get_eip = { E8 00 00 00 00 }     // call $+5
        $api_hash = { 68 [4] 58 }         // push hash, pop eax
        
    condition:
        any of them
}

rule process_injection {
    meta:
        description = "Обнаружение инъекции в процесс"
        author = "RuScan"
        severity = "high"
        
    strings:
        $alloc = "VirtualAlloc" ascii wide
        $write = "WriteProcessMemory" ascii wide
        $thread = "CreateRemoteThread" ascii wide
        $section = "NtCreateSection" ascii wide
        $map = "NtMapViewOfSection" ascii wide
        
    condition:
        2 of them
}

rule process_hollowing {
    meta:
        description = "Обнаружение Process Hollowing"
        author = "RuScan"
        severity = "high"
        
    strings:
        $unmap = "NtUnmapViewOfSection" ascii wide
        $write = "NtWriteVirtualMemory" ascii wide
        $resume = "NtResumeThread" ascii wide
        $hollow_pattern = { 00 00 48 [2-6] 48 [2-6] E8 }
        
    condition:
        2 of them
}

rule keylogger_behavior {
    meta:
        description = "Обнаружение кейлоггеров"
        author = "RuScan"
        severity = "medium"
        
    strings:
        $api1 = "GetAsyncKeyState" ascii wide
        $api2 = "GetKeyboardState" ascii wide
        $api3 = "SetWindowsHookEx" ascii wide
        $file = "keylog" nocase ascii wide
        
    condition:
        2 of them
}

rule credential_stealer {
    meta:
        description = "Обнаружение кражи учетных данных"
        author = "RuScan"
        severity = "high"
        
    strings:
        $chrome = "Chrome/User Data/Default" nocase ascii wide
        $firefox = "Firefox/Profiles" nocase ascii wide
        $windows = "Windows\\System32\\config\\SAM" nocase ascii wide
        $lsass = "lsass.exe" nocase ascii wide
        $cred = "CredentialStore" nocase ascii wide
        
    condition:
        2 of them
}

rule rat_behavior {
    meta:
        description = "Обнаружение удаленного управления"
        author = "RuScan"
        severity = "high"
        
    strings:
        $cmd = "cmd.exe /c " ascii wide
        $powershell = "powershell.exe -" ascii wide
        $wscript = "wscript.exe" ascii wide
        $connect = { 68 [4] ( 50 | 51 | 52 | 53 | 54 | 55 | 56 | 57 ) FF 15 }  // push IP; push reg; call
        
    condition:
        2 of them
}

rule persistence_mechanism {
    meta:
        description = "Обнаружение механизмов персистентности"
        author = "RuScan"
        severity = "medium"
        
    strings:
        $reg1 = "Software\\Microsoft\\Windows\\CurrentVersion\\Run" ascii wide
        $reg2 = "Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce" ascii wide
        $reg3 = "System\\CurrentControlSet\\Services" ascii wide
        $task = "\\Microsoft\\Windows\\Task Scheduler\\" ascii wide
        $startup = "\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\" ascii wide
        
    condition:
        2 of them
}

rule suspicious_network {
    meta:
        description = "Обнаружение подозрительной сетевой активности"
        author = "RuScan"
        severity = "medium"
        
    strings:
        $dns = { 00 35 00 00 }  // DNS port 53
        $http = "HTTP/1." ascii
        $connect = "CONNECT " ascii
        $sock = "WSASocket" ascii wide
        $packet = "PacketSend" ascii wide
        
    condition:
        2 of them
}

rule encrypted_content {
    meta:
        description = "Обнаружение зашифрованного контента"
        author = "RuScan"
        severity = "medium"
        
    strings:
        $entropy = /[\x00-\xFF]{100,}/ // Высокая энтропия
        $key = /[A-Za-z0-9+\/]{32,}={0,2}/ // Base64
        $salt = /salt/i ascii wide
        $iv = /iv/i ascii wide
        
    condition:
        2 of them and
        math.entropy(0, filesize) >= 7.0
}

rule anti_analysis {
    meta:
        description = "Обнаружение анти-анализа"
        author = "RuScan"
        severity = "high"
        
    strings:
        $dbg1 = "IsDebuggerPresent" ascii wide
        $dbg2 = "CheckRemoteDebuggerPresent" ascii wide
        $dbg3 = "OutputDebugString" ascii wide
        $vm1 = "VMware" ascii wide
        $vm2 = "VBox" ascii wide
        $time = "GetTickCount" ascii wide
        
    condition:
        2 of them
} 